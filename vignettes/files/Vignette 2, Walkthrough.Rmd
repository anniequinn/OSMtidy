---
title: "OSMtidy - Vignette 2, Walkthrough"
author: "Dr Annie Visser-Quinn, a.visser-quinn@hw.ac.uk"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{OSMtidy - Vignette 2, Walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

knitr::opts_knit$set(
  root.dir = normalizePath('../')
  )

library(tidyverse)
library(lubridate)
library(osmdata)
library(sf)
library(pbapply)
library(progress)
library(data.table)
library(readxl)
library(openxlsx)
library(mapedit)
```


## 1. Prerequisites
- OSMtidy V0.0.41
- An input shapefile - see Vignette 1 for a guide to getting started
- R version 3.6.3 or newer
- R packages `tidyverse`, `lubridate`, `osmdata`, `sf`, `mapedit`, `pbapply`, `progress`, `data.table`, `readxl` and `openxlsx`


## 2. Set-up
To use OSMtidy, you should save your R script within the OSMtidy directory. Set up your R script by (1) clearing the environment and console, (2) setting the working directory to your script directory, and (3) loading the required packages.

```{r, eval = FALSE} 
# Prepare the environment
rm(list = ls()); cat("/014"); gc() 

# Set working directory to the script's folder
setwd(dirname(rstudioapi::getSourceEditorContext()$path))

# Load the required packages
library(tidyverse)
library(lubridate)
library(osmdata)
library(sf)
library(pbapply)
library(progress)
library(data.table)
library(readxl)
library(openxlsx)
```
<br>

The functions that make up OSMtidy are located in the *functions* folder. You can load all of them in by running the script in *functions.R*; in the code chunk below, `ls()` prints the names of the functions loaded into the environment.

```{r}
source("functions/functions.R")

ls()
```

## 3. Using OSMtidy

### 3.1. Input shapefile
Using the function `dataShapefile()` we can import the shapefile for which data is to be extracted. There are two input arguments:

- *name* This is the location name. This should be the same as the name of the shapefile in the shapefiles folder (without the .shp file extension)
- *crs* Coordinate projection, optional. The function automatically converts to EPSG:4326 (https://epsg.io/4326).

```{r, eval = FALSE} 
locationName <- "exampleEdinburgh"

shp <- dataShapefile(name = locationName)
```
```{r, include = FALSE}
locationName <- "exampleEdinburgh"
shp <- readRDS("vignettes/files/shp.RDS")
```
```{r}
shp
```

<br>

At each step, you can print a summary of the OSMtidy outputs using the function `dataSummary()`.

```{r}
shp %>% dataSummary
```

<br>

You can also export any OSMtidy output using the function `dataExport()`. All outputs are time stamped and saved in the outputs folder within the OSMtidy directory. 

```{r}
dataExport(data = shp, name = locationName)
```


### 3.2. Extract OSM data via the R package osmdata
The OpenStreetMap data is extracted, via the R package osmdata and the overpass server, using the function `dataExtract()`. Timestamps and progress are printed while the function is running. 

OSMtidy V0.0.41 extracts 47 of 209 available features in osmdata. To change the features extracted, add or delete lines in `functions/features.txt`. A list of the available features in osmdata can be accessed via the function `osmdata::available_features`.

The function `dataExtract()` has three input arguments: 

- *dataShapefile* The output from 3.1 (step 1)
- *timeout* The time in seconds before the query to the overpass server will time out; see DETAILS below
  - Default 300 seconds
- *memsize* The memory size for the overpass server; see DETAILS below
  - Default 1073741824 Bytes
  
#### 3.2.1 DETAILS from the R package osmdata
> **timeout** It may be necessary to increase this value for large queries, because the server may time out before all data are delivered.
> **memsize** The default memory size for the 'overpass' server in bytes; may need to be increased in order to handle large queries.>
> See https://wiki.openstreetmap.org/wiki/Overpass_API#Resource_management_options_.28osm-script.29 for explanation of timeout and memsize (or maxsize in overpass terms). Note in particular the comment that queries with arbitrarily large memsize are likely to be rejected.

<br>

The code chunk below is not run. This is because (1) the data extraction may take some time depending on the size of the area; and (2), to avoid flooding the overpass server.

```{r, eval = FALSE}
dlExtract <- dataExtract(dataShapefile = shp)
```
```{r, eval = TRUE, echo = FALSE}
dlExtract <- readRDS("vignettes/files/exampleEdinburgh/exampleEdinburgh_2_dataExtract.RDS")
```

<br>

The output can be interrogated and exported, using the functions `dataSummary()` and `dataExport()` respectively, as before.

```{r}
dlExtract %>% dataSummary

dataExport(data = dlExtract, name = locationName)
```


### 3.3. Cut out data
In 3.2 (step 2), the data was extracted as a "bounding box" (a rectangle). In step 3, the data is cut to the shapefile using the function `dataCut()`. Timestamps and progress are printed when the function is running. The function `dataCut` has two input arguments: 

- **dataExtracted** Output from 3.2 (step 2)
- **dataShapefile** Output from 3.1 (step 1)

Outputs can be interrogated and exported as before.

```{r}
dlCut <- dataCut(dataExtracted = dlExtract, dataShapefile = shp)

dlCut %>% dataSummary

dataExport(data = dlCut, name = locationName)
```


### 3.4. Data wrangling
Using the function `dataWrangle` we can tidy up (or wrangle) the data before filtering. Timestamps and progress are printed when the function is running. There is one input argument: 

- **dataCut** Output from 3.3 (step 3)

```{r}
dlWrangle <- dataWrangle(dataCut = dlCut)

dlWrangle %>% dataSummary

dataExport(data = dlWrangle, name = locationName)
```


### 3.5. Data filtering
The main function of OSMtidy is `dataFilter()`. Here, the data is filtered based on rules set out in the excel file *filters.xlsx*; this can be found in the main OSMtidy directory. You may adjust these rules by editting the spreadsheet. See Vignette 3 for further details. Timestamps and progress are printed when the function is running. There are three input arguments to `dataFilter()`:

- **dataWrangle** Output from 3.4 (step 4)
- **filters** Name of the the filters spreadsheet
  - Default to filters.xlsx
  - Use the function `filterOverview()` for an overview of the filtered objects
- **rows** Specify the rows in the spreadsheet to use as filters. Intended for troubleshooting and adjusting filters
  - Default to NULL, i.e. all filters or rows

Depending on the location size, number of filters and computer performance, filters can take anything from a couple of minutes (the example ward) to multiple hours to run (City of London and Boroughs). The code chunk below is not run. 
```{r, eval = FALSE}
dlFilter <- dataFilter(dataWrangle = dlWrangle, filters = "filters.xlsx")
```
```{r, eval = TRUE, echo = FALSE}
dlFilter <- readRDS("vignettes/files/dlFilter.RDS")
```

<br>

The output may be interrogated and exported as before.

```{r}
dlFilter %>% dataSummary

dataExport(data = dlFilter, name = locationName)
```

### 3.6. Data tidy
The final step. The function `dataTidy()` generates a single tidied output based on any combination of the filtered, validated, unfiltered and no detail data. 

Note that multiple outputs from `dataWrangle()` and `dataFilter()` were spreadsheets (.xlsx extension). You may manually adjust the *desc* column in these and reimport them in this step.

The input argument is a list of the objects to be imported. They can either be imported locally, as objects from the R environment, or from the manually adjusted spreadsheets. The code chunk below focusses on the outputs of `dataFilter()` only. Vignettes 3 and 4 introduce a number of alternative inputs. 

The tidied geotagged dataset is saved in .RDS, and .csv for use in a range of applications. To export as a shapefile it is necessary to split the geotagged dataset by geometry type first. 


```{r} 
dlTidy <- dataTidy(dlFilter)

dlTidy %>% dataSummary

dlTidy$filtered

dataExport(data = dlTidy, name = locationName)
```